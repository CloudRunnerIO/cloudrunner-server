%if 0%{?fedora} > 16
%define __python python2.7
%endif

%{!?python_sitelib: %global python_sitelib %(%{__python} -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())")}


Name:       cloudrunner
Version:    0.2
Release:    2.bstk%{?dist}
Summary:    CloudRunner engine for running scripts in cloud environment
Group:      Cloud tools
License:    Apache2
URL:        http://www.cloudrunner.io/
Source0:    %{name}-%{version}.tar.gz
BuildRoot:  %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildArch:   noarch

BuildRequires: python-setuptools

BuildRequires: gcc
BuildRequires: gcc-c++
BuildRequires: python-devel

Requires: python-argparse
Requires: python-crontab
Requires: m2crypto
Requires: python-zmq
Requires: python-httplib2
Requires: python-setuptools

%if 0%{?rhel} < 7 && 0%{?fedora} < 13
Requires: python-importlib
%endif

%description
CloudRunner execution engine. Consists of three modules:
1. Master (cloudrunner-dsp service) - Starts a Master dispatcher server
2. Node (cloudrunner-node) service - Starts an agent on a server node
3. Agent/Runner (cloudrunner) - a tool to connect and run scripts on nodes
This package contains common  libs and files.


%package dispatcher
Summary:    CloudRunner dispatcher
Group:      Cloud tools
Requires:   %{name} = %{version}-%{release}
%description dispatcher
CloudRunner engine for running scripts in cloud environment.
This package contains Dispatcher node service software.

%prep
%setup -q

%build
%{__python} setup.py build


%install
rm -rf %{buildroot}

# The python package
%{__python} setup.py install -O1 --skip-build --root $RPM_BUILD_ROOT


mkdir -p $RPM_BUILD_ROOT/%{_sysconfdir}/%{name}
install -m644 conf/cloudrunner.conf $RPM_BUILD_ROOT/%{_sysconfdir}/%{name}/

mkdir -p $RPM_BUILD_ROOT/%{_initrddir}
install -m755 etc/rc.d/init.d/centos/cloudrunner-dsp $RPM_BUILD_ROOT/%{_initrddir}

sed -i -e 's,{lib_dir},%{python_sitelib},g' $RPM_BUILD_ROOT/%{_sysconfdir}/%{name}/cloudrunner.conf
sed -i -e 's,{ca_dir},%{_sharedstatedir}/cloudrunner/CA,g' $RPM_BUILD_ROOT/%{_sysconfdir}/%{name}/cloudrunner.conf
sed -i -e 's,{var_dir},%{_sharedstatedir}/cloudrunner,g' $RPM_BUILD_ROOT/%{_sysconfdir}/%{name}/cloudrunner.conf

mkdir -p $RPM_BUILD_ROOT/var/run/sock/cloudrunner/
mkdir -p $RPM_BUILD_ROOT/var/run/cloudrunner/
mkdir -p $RPM_BUILD_ROOT/var/lib/cloudrunner/

%clean
rm -rf %{buildroot}

%files
%defattr(-,root,root,-)
%doc README.rst

%dir %{python_sitelib}/cloudrunner-server/
%{python_sitelib}/cloudrunner-server/tests/*
%{python_sitelib}/cloudrunner-server/__init__*
%{python_sitelib}/cloudrunner-server/plugins
%{python_sitelib}/cloudrunner-server-%{version}-py*.egg-info

%dir /var/run/cloudrunner/
%dir /var/run/sock/cloudrunner/
%dir /var/lib/cloudrunner/

%files dispatcher
%{_bindir}/cloudrunner-dsp
%{_bindir}/cloudrunner-master

%{python_sitelib}/cloudrunner-server/db
%{python_sitelib}/cloudrunner-servermaster/dispatcher
%{python_sitelib}/cloudrunner-server/master

%{_initrddir}/cloudrunner-dsp
%config(noreplace) %{_sysconfdir}/cloudrunner/cloudrunner.conf

%changelog
* Mon Jan 20 2014 Tihomir Trifonov <ttrifonov at cloudrunner dot io> - 0.1-1
- Initial package config
